---
id: building-with-detox
slug: introduction/building-with-detox
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

import PrepareAppConfigsIos from './Introduction.BuildingWithDetox.AppConfigs.iOS.mdx';
import PrepareAppConfigsAndroid from './Introduction.BuildingWithDetox.AppConfigs.Android.mdx';
import PrepareDeviceConfigsIos from './Introduction.BuildingWithDetox.DeviceConfigs.iOS.mdx';
import PrepareDeviceConfigsAndroid from './Introduction.BuildingWithDetox.DeviceConfigs.Android.mdx';

# Building for Detox

:::info

This article targets standard or just-generated React Native projects.
If some steps don't look applicable to your project, please adapt them accordingly
or skip, relying on the common sense.

:::

After Detox generated these files in your project's root, you still have some work to do with them:

* `.detoxrc.js` – Detox' own configuration file;
* `e2e/jest.config.js` – test runner configuration;
* `e2e/starter.test.js` – dummy first test.

## Step 1: App configs

In this step you need to provide Detox with the right **commands to build** your app for iOS and Android,
and also the right **paths to the app binaries** so that Detox can install your app on the device before
actually starting the tests.

<Tabs groupId="mobileOs">
    <TabItem value="iOS" label="iOS" default>
        <PrepareAppConfigsIos />
    </TabItem>
    <TabItem value="Android" label="Android">
        <PrepareAppConfigsAndroid />
    </TabItem>
</Tabs>

## Step 2: Device configs

By default, Detox config suggests default device types for iOS and Android:

```javascript
module.exports = {
  // ...
  devices: {
    simulator: {
      type: 'ios.simulator',
      device: {
        // highlight-next-line
        type: 'iPhone 12',
      },
    },
    attached: {
      type: 'android.attached',
      device: {
        // highlight-next-line
        adbName: '.*', // any attached device
      },
    },
    emulator: {
      type: 'android.emulator',
      device: {
        // highlight-next-line
        avdName: 'Pixel_3a_API_30_x86',
      },
    },
  },
};
```

Here's how you can check they are correct and change them if you need something else:

<Tabs groupId="mobileOs">
    <TabItem value="iOS" label="iOS">
        <PrepareDeviceConfigsIos />
    </TabItem>
    <TabItem value="Android" label="Android" default>
        <PrepareDeviceConfigsAndroid />
    </TabItem>
</Tabs>

## Step 3: Android configuration

This is a long and challenging section to complete, so have patience before you start it.

If you don't need to run tests on Android,
you can jump ahead to [Step 4: Build Your App](#step-4-build-your-app) for iOS.

### 1. Add the Native Detox dependency

:::info

If, for some reason, you wish to configure Detox as a _compiling dependency_, refer to
_Setting Detox up as a compiling dependency_ guide. This tutorial assumes you'll be using
Detox as a precompiled `.aar`, which is the recommended way.

:::

In your _root_ `buildscript` (i.e. `android/build.gradle`), register both `google()` _and_ detox as repository lookup points in all projects:

```groovy title="android/build.gradle"
// Note: add the 'allprojects' section if it doesn’t exist
allprojects {
    repositories {
        // ...
        google()
        maven {
            // All of Detox' artifacts are provided via the npm module
            url "$rootDir/../node_modules/detox/Detox-android"
        }
    }
}
```

In your app’s `buildscript` (i.e. `android/app/build.gradle`) add this in `dependencies` section:

```groovy
dependencies {
    // ...
```

also ensure that this line appears in `dependencies`:

```groovy
dependencies {
    // ...
    implementation 'androidx.appcompat:appcompat:1.1.0' // (check what the latest version is!)
}
```

... and add this to the `defaultConfig` subsection:

```groovy
android {
  // ...

  defaultConfig {
      // ...
      testBuildType System.getProperty('testBuildType', 'debug')  // This will later be used to control the test apk build type
      testInstrumentationRunner 'androidx.test.runner.AndroidJUnitRunner'
  }
}
```

Please be aware that the `minSdkVersion` needs to be at least 18.

### 4. Add Kotlin

If your project does not already support Kotlin, add the Kotlin Gradle-plugin to your `classpath` in the root build-script (i.e.`android/build.gradle`):

```groovy
buildscript {
    // ...
    ext.kotlinVersion = '1.3.0' // (check what the latest version is!)
    dependencies {
        // ...
        classpath "org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlinVersion"
    }
}
```

_Note: most guides advise of defining a global `kotlinVersion` constant - as in this example, but that is not mandatory._

_**Note that Detox has been tested for version 1.1.0 of Kotlin, and higher!**_

### 5. Create a Detox-Test Class

Detox requires a dummy implementation of a single Android-native test.

1. Add a new file to your project, under this path and name: `android/app/src/androidTest/java/com/[your.package]/DetoxTest.java`. **Double-check that the path is correct!**
1. Copy & paste the content of the equivalent file from [the detox example app for RN](https://github.com/wix/Detox/tree/master/examples/demo-react-native/android/app/src/androidTest/java/com/example/DetoxTest.java), into it. **Don’t forget to change the package name to your project’s package name!**

### 6. Enable clear-text (unencrypted) traffic for Detox

Starting from Android SDK API level 28, Google have disabled all clear-text network traffic by default. Namely, unless explicitly configured, all of your application’s outgoing unencrypted traffic (i.e. non-TLS using HTTP rather than HTTPS) is blocked by the device.

For Detox to work, Detox test code running on the device must connect to the test-running host through its virtual localhost interface<sup>(\*)</sup> using simple HTTP traffic. Therefore, the following network-security exemption configuration must be applied --

_In an XML resource file, e.g. `android/app/src/main/res/xml/network_security_config.xml`:_

```xml
<?xml version="1.0" encoding="utf-8"?>
<network-security-config>
    <domain-config cleartextTrafficPermitted="true">
        <domain includeSubdomains="true">10.0.2.2</domain>
        <domain includeSubdomains="true">localhost</domain>
    </domain-config>
</network-security-config>
```

_In the app’s `AndroidManifest.xml`_

```xml
<manifest>
  <application
        ...
        android:networkSecurityConfig="@xml/network_security_config">
  </application>
</manifest>
```

> _Refer to the [Detox example app](https://github.com/wix/Detox/tree/master/examples/demo-react-native/android/app/src/main) for an example on how this is effectively implemented._

**Note: if properly configured, this in no way compromises the security settings of your app.**

For full details, refer to [Android’s security-config guide](https://developer.android.com/training/articles/security-config), and the dedicated article in the [Android developers blog](https://android-developers.googleblog.com/2016/04/protecting-against-unintentional.html).

> _(\*) 10.0.2.2 for Google emulators, 10.0.3.2 for Genymotion emulators._

### 7. ProGuard (Minification, Obfuscation)

In apps running [minification using ProGuard](https://developer.android.com/studio/build/shrink-code), in order for Detox to work well on release builds, please enable some Detox ProGuard configuration rules by applying the custom configuration file on top of your own. Typically, this is defined using the `proguardFiles` statement in the minification-enabled build-type in your `app/build.gradle`:

```groovy
    buildTypes {
        // 'release' is typically the default proguard-enabled build-type
        release {
            minifyEnabled true

            // Typical pro-guard definitions
            proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'
            // Detox-specific additions to pro-guard
            proguardFile "${rootProject.projectDir}/../node_modules/detox/android/detox/proguard-rules-app.pro"
        }
    }

```

:warning: **Note:** In order for Detox to be able to work properly, in `proguard-rules-app.pro`, it effectively declares rules that retain most of React-Native’s code (i.e. keep it unminified, unobfuscated) in your **production** APK. Though generally speaking, this should not be an issue (as React-Native is an open-source project), there are ways around that, if it bothers you. For example, running your E2E over a build-type specifically designed to run E2E tests using Detox would do the trick -- roughly, like so (in `app/build.gradle`):

```groovy
    buildTypes {
        release {
            minifyEnabled true
            proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'

            signingConfig signingConfigs.release
        }
        releaseE2E {
            initWith release
            setMatchingFallbacks('release')

            proguardFile "${rootProject.projectDir}/../node_modules/detox/android/detox/proguard-rules-app.pro"
        }
    }
```

Here we utilize Gradle’s `initWith` to easily define `releaseE2E` in a way that is identical to the `release` build-type, with the exception of considering Detox' `proguard-rules-app.pro` in the minification process.

Following the example, you would then have to build your app using `gradlew assembleReleaseE2E` rather than `gradlew assembleRelease` before running Detox, and instruct Detox (i.e. via `binaryPath` in the Detox configuration file) to use the APK resulted specifically by _that_ Gradle target (e.g. in `app/build/apk/releaseE2E/app-releaseE2E.apk` instead of the equivalent `app/build/apk/release/app-release.apk`).

> Note: if your app contains flavors -- that makes things a bit trickier, but the approach can generally be adjusted to support that as well.

**Last but not least:** If you’re having issue with Detox' ProGuard rules, please report them [here](https://github.com/wix/Detox/issues/new/choose).
A special thanks to [@GEllickson-Hover](https://github.com/GEllickson-Hover) for reporting issues related to obfuscation in [#2431](https://github.com/wix/Detox/issues/2431).

### 8. Test Butler Support (Optional)

If, when [setting up your work environment](Introduction.AndroidDevEnv.md), you’ve selected Google emulators with an AOSP image as the test target - as recommended,
**we strongly encourage** you would also integrate [Test Butler](https://github.com/linkedin/test-butler): in the very least - in order to suppress crash and ANR dialogs.
They are a soft spot in UI testing on Android, all around, as - when displayed,they make the UI entirely inaccessible (and thus cause tests to fail in bulks).

Setting Test Butler up for working with Detox is a bit different than explained in their guides. The process, as a whole, is twofold:

1. Preinstalling the test-butler-app APK onto the test device.
1. Integrating the test-butler-lib into your own test APK, and initializing it in a custom test runner (as explained).

The library part can be easily achieved as explained there (i.e. by using Gradle’s `androidTestImplementation`). Same goes for initialization. As for the APK, the suggested usage of Gradle’s `androidTestUtil` is scarce when running with Detox (i.e. non-native instrumentation tests). Here’s what to do instead.

> _For a complete and thorough coverage of the Test Butler integration with Detox, consider going over our [blogpost on CI execution](https://medium.com/wix-engineering/how-to-execute-android-ui-tests-on-ci-and-stay-alive-eb9089d88c1f) on medium_.

#### Solution 1: Prebaked Images

If you have control over the emulators' snapshots, simply download (see test-butler’s guide) and install the test-butler APK once (e.g. use `adb install -r -t path/to/test-butler-app.apk`), and save an updated version of the snapshot. This is the best solution.

> Note: you will have to reiterate this if you upgrade to a newer version of Test-Butler, in the future.

#### Solution 2: Dynamic Installation

Assuming you have the APK available in the system, you can dynamically have Detox automatically install it in all of the running target-emulators by utilizing `utilBinaryPaths` in your Detox configuration. Example:

```json
{
  "devices": {
    "emulator.oss": {
      "type": "android.emulator",
      "device": "...",
      "utilBinaryPaths": ["relative/path/to/test-butler-app-2.2.1.apk"],
    }
  }
}
```

> Refer to our [configuration guide](APIRef.Configuration.md) for further details on `utilBinaryPaths`.

As per _making_ the APK available - for that, we have no really good solution, for the time being (but it’s in the works). A few options might be:

a. In a custom script, have it predownloaded from Maven directly, as suggested in the Test Butler guide. For example (on a Mac / Linux):

```sh
curl -f -o ./temp/test-butler-app.apk https://repo1.maven.org/maven2/com/linkedin/testbutler/test-butler-app/2.2.1/test-butler-app-2.2.1.apk
```

_Jests' [global-setup](https://jestjs.io/docs/en/configuration#globalsetup-string) is a recommend place for those kinds of things._

> Should you decide to go this path, we recommend you add `./temp/test-butler-app.apk` to the relevant `.gitignore`.

b. (Discouraged) Add it to your source control (e.g. git), as part of the repository.

## Step 4: Build Your App

### 1. Build Your App

Use a convenience method in Detox command line tools to build your project easily:

```sh
detox build --configuration <your configuration name>
```

> **Note:** Detox executes the build command you specified in your Detox configuration. If your build fails, make sure to provide the correct build command.

### 2. Start React Native packager

Assuming you are testing a React Native app, before you run Detox tests,
you need to make sure the packager is running in parallel:

```bash
npx react-native start

#                        #######
#                   ################
#                #########     #########
#            #########             ##########
#        #########        ######        #########
#       ##########################################
#      #####      #####################       #####
#      #####          ##############          #####
#      #####    ###       ######       ###    #####
#      #####    #######            #######    #####
#      #####    ###########    ###########    #####
#      #####    ##########################    #####
#      #####    ##########################    #####
#      #####      ######################     ######
#       ######        #############        #######
#         #########        ####       #########
#              #########          #########
#                  ######### #########
#                       #########
#
#
#                    Welcome to Metro!
#              Fast - Scalable - Integrated
```

### 3. Run the Tests

Use the Detox command line tools to test your project easily:

```sh
detox test --configuration <your configuration name>
```

That’s it. Your first failing Detox test is running!

```plain text
● Example › should have welcome screen

  Test Failed: No elements found for “MATCHER(id == “welcome”)”

  HINT: To print view hierarchy on failed actions/matches, use log-level verbose or higher.

     9 |
    10 |   it('should have welcome screen', async () => {
  > 11 |     await expect(element(by.id('welcome'))).toBeVisible();
       |                                             ^
    12 |   });
    13 |
    14 |   it('should show hello screen after tap', async () => {

    at Object.toBeVisible (test/e2e/starter.test.js:11:45)
```

Next, we’ll go over usage and how to make this test [actually pass](Introduction.WritingFirstTest.md).

## Troubleshooting

Please refer to [troubleshooting guide about build issues](Troubleshooting.BuildingTheApp.md#android) for assistance.

